# v0.3.2 ç‰ˆæœ¬æ›´æ–°æ‘˜è¦

## ğŸ“… å‘å¸ƒä¿¡æ¯
- **ç‰ˆæœ¬å·**: v0.3.2
- **å‘å¸ƒæ—¥æœŸ**: 2025-01-19
- **æ›´æ–°ç±»å‹**: API é€‚é… & æ•°æ®ç»“æ„ä¼˜åŒ–

## ğŸ¯ æ›´æ–°ç›®æ ‡

æœ¬æ¬¡æ›´æ–°ä¸»è¦è§£å†³å‰ç«¯ä¸åç«¯ `/api/v1/chatlog` æ¥å£è¿”å›æ•°æ®ç»“æ„ä¸åŒ¹é…çš„é—®é¢˜ï¼Œç¡®ä¿æ¶ˆæ¯æ•°æ®èƒ½å¤Ÿæ­£ç¡®è§£æå’Œæ˜¾ç¤ºã€‚

## ğŸ”§ ä¸»è¦å˜æ›´

### 1. ç±»å‹å®šä¹‰æ›´æ–°

**æ–‡ä»¶**: `src/types/message.ts`

- âœ… æ–°å¢ `MessageResponse` æ¥å£ï¼šå®šä¹‰åç«¯è¿”å›çš„åŸå§‹æ•°æ®ç»“æ„
- âœ… æ‰©å±• `Message` æ¥å£ï¼šæ·»åŠ  `contents` å­—æ®µæ”¯æŒæ‰©å±•å†…å®¹
- âœ… ä¿ç•™å‰ç«¯ç»Ÿä¸€ä½¿ç”¨çš„ `Message` ç±»å‹

### 2. API æ•°æ®è½¬æ¢å±‚

**æ–‡ä»¶**: `src/api/chatlog.ts`

æ–°å¢è½¬æ¢å‡½æ•°ï¼š

```typescript
transformMessage(response: MessageResponse): Message
transformMessages(responses: MessageResponse[]): Message[]
```

**è½¬æ¢å†…å®¹**ï¼š
- æ—¶é—´æ ¼å¼ï¼šISO 8601 å­—ç¬¦ä¸² â†’ Unix æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
- æ¶ˆæ¯ IDï¼šä½¿ç”¨ `seq` ä½œä¸ºå”¯ä¸€æ ‡è¯†
- å­—æ®µæå–ï¼šä» `contents` æå–å¸¸ç”¨å­—æ®µï¼ˆfileNameã€fileUrlï¼‰
- å¸ƒå°”è½¬æ•°å­—ï¼š`isSelf` â†’ `isSend` (0/1)

### 3. Store å±‚é€‚é…

**æ–‡ä»¶**: `src/stores/chat.ts`

- âœ… æ›´æ–° `formatMessageDate` å‡½æ•°æ”¯æŒåŒæ—¶é—´æ ¼å¼ï¼ˆISO å­—ç¬¦ä¸² | Unix ç§’ï¼‰

### 4. ç»„ä»¶å±‚ä¼˜åŒ–

#### MessageList.vue
- âœ… ä¿®æ­£å¤´åƒæ˜¾ç¤ºé€»è¾‘ï¼šæ¯”è¾ƒ `sender` è€Œé `talker`
- âœ… ä¿®æ­£æ—¶é—´æ¯”è¾ƒé€»è¾‘ï¼šå…¼å®¹ `createTime` å’Œ `time` åŒæ ¼å¼
- âœ… ä¿®æ­£åç§°æ˜¾ç¤ºé€»è¾‘ï¼šæ¯”è¾ƒ `sender` è€Œé `talker`

#### MessageBubble.vue
- âœ… ä½¿ç”¨ `senderName || sender` ä½œä¸ºå‘é€è€…æ˜¾ç¤ºå
- âœ… ä» `contents?.title` è·å–æ–‡ä»¶å
- âœ… æ–°å¢å¼•ç”¨æ¶ˆæ¯æ”¯æŒï¼ˆtype=49, subType=57ï¼‰
- âœ… æ·»åŠ æ–‡ä»¶å¤§å°æ ¼å¼åŒ–å‡½æ•°

### 5. å·¥å…·å‡½æ•°å¢å¼º

**æ–‡ä»¶**: `src/utils/date.ts`

- âœ… `formatMessageTime` æ”¯æŒ ISO 8601 å­—ç¬¦ä¸²æˆ– Unix æ—¶é—´æˆ³

## ğŸ“Š åç«¯æ•°æ®ç»“æ„

### æ¶ˆæ¯å¯¹è±¡ç»“æ„

```json
{
  "seq": 1763519753000,
  "time": "2025-11-19T10:35:53+08:00",
  "talker": "47506612649@chatroom",
  "talkerName": "æ™ºäº‘äº§æ•™èåˆç§‘åˆ›å¹³å°æŠ€æœ¯å¯¹æ¥",
  "isChatRoom": true,
  "sender": "wxid_4030390300812",
  "senderName": "Enter",
  "isSelf": false,
  "type": 49,
  "subType": 6,
  "content": "",
  "contents": {
    "md5": "4bd2cc11aec72c61f936c36434791476",
    "title": "è‡ªåŠ¨åŒ–éƒ¨ç½²æµ‹è¯•åˆ¸ç”³è¯·æŒ‡å¯¼-æ–°.docx"
  }
}
```

## ğŸ”‘ å…³é”®æ¦‚å¿µ

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `seq` | number | æ¶ˆæ¯åºåˆ—å·ï¼ˆæ¯«ç§’çº§æ—¶é—´æˆ³ï¼‰ï¼Œä½œä¸ºå”¯ä¸€ ID |
| `time` | string | ISO 8601 æ ¼å¼æ—¶é—´å­—ç¬¦ä¸² |
| `talker` | string | ä¼šè¯ IDï¼ˆç¾¤èŠæˆ–ä¸ªäººèŠå¤©çš„æ ‡è¯†ï¼‰ |
| `sender` | string | å‘é€è€… IDï¼ˆç¾¤èŠä¸­çš„å…·ä½“å‘é€äººï¼‰ |
| `isChatRoom` | boolean | æ˜¯å¦ä¸ºç¾¤èŠæ¶ˆæ¯ |
| `isSelf` | boolean | æ˜¯å¦ä¸ºæœ¬äººå‘é€ |
| `contents` | object | æ‰©å±•å†…å®¹å¯¹è±¡ï¼ˆå¯é€‰ï¼‰ |

### æ¶ˆæ¯ç±»å‹

| type | subType | è¯´æ˜ | contents å­—æ®µ |
|------|---------|------|---------------|
| 1 | 0 | æ–‡æœ¬æ¶ˆæ¯ | - |
| 3 | 0 | å›¾ç‰‡æ¶ˆæ¯ | `{ md5 }` |
| 34 | 0 | è¯­éŸ³æ¶ˆæ¯ | - |
| 43 | 0 | è§†é¢‘æ¶ˆæ¯ | `{ md5 }` |
| 47 | 0 | è¡¨æƒ…æ¶ˆæ¯ | - |
| 49 | 5 | é“¾æ¥æ¶ˆæ¯ | `{ title, url }` |
| 49 | 6 | æ–‡ä»¶æ¶ˆæ¯ | `{ md5, title }` |
| 49 | 57 | å¼•ç”¨æ¶ˆæ¯ | `{ refer: Message }` |
| 10000 | 0 | ç³»ç»Ÿæ¶ˆæ¯ | - |

### å¼•ç”¨æ¶ˆæ¯ï¼ˆReplyï¼‰

å½“ `type=49 && subType=57` æ—¶ï¼Œ`contents.refer` åŒ…å«è¢«å¼•ç”¨çš„æ¶ˆæ¯å¯¹è±¡ï¼š

```json
{
  "type": 49,
  "subType": 57,
  "content": "å›å¤çš„æ–‡æœ¬å†…å®¹",
  "contents": {
    "refer": {
      "sender": "wxid_xxx",
      "senderName": "å‘é€è€…",
      "type": 1,
      "content": "è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹"
    }
  }
}
```

## ğŸ”„ æ•°æ®æµç¨‹

```
åç«¯ API (MessageResponse[])
    â†“
chatlogAPI.transformMessages()
    â†“
Store (Message[])
    â†“
Component
    â†“
ç”¨æˆ·ç•Œé¢
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æ—¶é—´æ ¼å¼åŒè½¨åˆ¶

å‰ç«¯åŒæ—¶ä¿ç•™ä¸¤ç§æ—¶é—´æ ¼å¼ï¼š

- `time` (string): ISO 8601 å­—ç¬¦ä¸²ï¼Œç”¨äºç²¾ç¡®æ—¶é—´å’Œè·¨æ—¶åŒº
- `createTime` (number): Unix ç§’çº§æ—¶é—´æˆ³ï¼Œç”¨äºæ’åºå’Œæ¯”è¾ƒ

### 2. ç¾¤èŠæ¶ˆæ¯åŒºåˆ†

- **å•èŠ**: `talker` = `sender`ï¼ˆå¯¹æ–¹ wxidï¼‰
- **ç¾¤èŠ**: `talker` = ç¾¤ IDï¼Œ`sender` = å‘é€è€… wxid
- æ˜¾ç¤ºé€»è¾‘ï¼šä½¿ç”¨ `sender` æ¯”è¾ƒè¿ç»­æ¶ˆæ¯æ˜¯å¦åŒä¸€äºº

### 3. contents æ‰©å±•æ€§

`contents` å¯¹è±¡ä½¿ç”¨ `[key: string]: any` ç±»å‹ï¼Œå…è®¸ï¼š
- ä¸åŒæ¶ˆæ¯ç±»å‹æœ‰ä¸åŒå­—æ®µ
- åç«¯æ·»åŠ æ–°å­—æ®µæ— éœ€ä¿®æ”¹ç±»å‹
- åµŒå¥—å¤æ‚ç»“æ„ï¼ˆå¦‚å¼•ç”¨æ¶ˆæ¯ï¼‰

## âœ… æµ‹è¯•æ¸…å•

### æ¶ˆæ¯ç±»å‹æ˜¾ç¤º
- [ ] æ–‡æœ¬æ¶ˆæ¯æ­£å¸¸æ˜¾ç¤º
- [ ] å›¾ç‰‡æ¶ˆæ¯æ­£å¸¸åŠ è½½
- [ ] æ–‡ä»¶æ¶ˆæ¯æ˜¾ç¤ºæ–‡ä»¶å
- [ ] é“¾æ¥æ¶ˆæ¯æ˜¾ç¤ºæ ‡é¢˜å’Œ URL
- [ ] å¼•ç”¨æ¶ˆæ¯æ˜¾ç¤ºè¢«å¼•ç”¨å†…å®¹
- [ ] ç³»ç»Ÿæ¶ˆæ¯æ­£ç¡®æ ¼å¼åŒ–

### æ—¶é—´æ˜¾ç¤º
- [ ] ä»Šå¤©æ¶ˆæ¯æ˜¾ç¤º "HH:MM"
- [ ] æ˜¨å¤©æ¶ˆæ¯æ˜¾ç¤º "æ˜¨å¤© HH:MM"
- [ ] æœ¬å‘¨æ¶ˆæ¯æ˜¾ç¤º "å‘¨X HH:MM"
- [ ] å¾€å¹´æ¶ˆæ¯æ˜¾ç¤ºå®Œæ•´æ—¥æœŸ

### ç¾¤èŠåŠŸèƒ½
- [ ] ç¾¤èŠæ¶ˆæ¯æ˜¾ç¤ºå‘é€è€…åç§°
- [ ] è¿ç»­æ¶ˆæ¯ä¼˜åŒ–ï¼ˆå¤´åƒ/åç§°/æ—¶é—´ï¼‰
- [ ] ç¾¤èŠå’Œå•èŠæ¶ˆæ¯åŒºåˆ†æ­£ç¡®

### è¾¹ç•Œæƒ…å†µ
- [ ] ç©º contents ä¸æŠ¥é”™
- [ ] ç¼ºå¤±å­—æ®µä½¿ç”¨é»˜è®¤å€¼
- [ ] æ—¶é—´æ ¼å¼è½¬æ¢æ­£ç¡®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [API æ•°æ®ç»“æ„å¯¹ç…§è¡¨](../API_DATA_STRUCTURE.md)
- [Chatlog API é€‚é…è¯´æ˜](../CHATLOG_API_ADAPTATION.md)
- [å¼€å‘è€…æŒ‡å—](../DEVELOPER_GUIDE.md)

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] å®ç°åª’ä½“æ–‡ä»¶é¢„è§ˆï¼ˆå›¾ç‰‡ã€è§†é¢‘ï¼‰
- [ ] å®ç°è¯­éŸ³æ’­æ”¾åŠŸèƒ½
- [ ] å®ç°æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
- [ ] ä¼˜åŒ–å¼•ç”¨æ¶ˆæ¯æ˜¾ç¤ºæ ·å¼
- [ ] æ·»åŠ æ¶ˆæ¯é•¿æŒ‰èœå•
- [ ] å®ç°æ¶ˆæ¯æœç´¢é«˜äº®

## ğŸ”— ç›¸å…³æäº¤

æŸ¥çœ‹è¯¦ç»†ä»£ç å˜æ›´ï¼š
- `src/types/message.ts` - ç±»å‹å®šä¹‰æ›´æ–°
- `src/api/chatlog.ts` - æ•°æ®è½¬æ¢é€»è¾‘
- `src/stores/chat.ts` - Store é€‚é…
- `src/components/chat/MessageList.vue` - ç»„ä»¶æ›´æ–°
- `src/components/chat/MessageBubble.vue` - æ¶ˆæ¯æ°”æ³¡ä¼˜åŒ–
- `src/utils/date.ts` - æ—¶é—´å·¥å…·å‡½æ•°å¢å¼º

---

**æ›´æ–°å®Œæˆ** âœ¨

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
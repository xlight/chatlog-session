# Changelog

## [0.10.0] - 2025-11-21

### Added

#### 搜索功能增强

- **聊天页面搜索集成**
  - 新增 `SearchDialog` 组件，支持在聊天界面内搜索
  - 搜索对话框支持桌面端和移动端自适应
  - 移动端全屏显示，桌面端 80% 宽度居中对话框
  - 可拖拽对话框（桌面端）

- **群聊搜索功能**
  - 支持按群聊名称搜索
  - 即时显示搜索结果
  - 点击结果直接跳转到对应聊天会话

- **移动端日期选择器优化**
  - 移动端使用两个独立的单日期选择器（开始日期 + 结束日期）
  - 桌面端保持日期范围选择器
  - 自动同步移动端和桌面端的日期数据
  - 水平布局，适配小屏幕

#### 群聊管理系统
- **新增群聊 API 模块** (`src/api/chatroom.ts`)
  - 实现 `/api/v1/chatroom` 接口集成
  - 支持群聊列表获取、详情查询、成员信息获取
  - 提供批量获取群聊详情功能
  - 支持群聊搜索功能

- **新增群聊 Store** (`src/stores/chatroom.ts`)
  - 集中管理群聊数据和状态
  - 提供群聊加载、刷新、搜索等操作
  - 支持群聊成员数量和成员列表查询
  - 实现内存缓存和 IndexedDB 持久化

- **扩展 IndexedDB 支持**
  - 新增 `chatrooms` ObjectStore 用于群聊数据缓存
  - 创建群聊相关索引：`name`、`owner`、`memberCount`
  - 提供批量保存/读取/搜索/删除群聊数据方法
  - 升级数据库版本至 v3

- **群聊类型定义** (`src/types/contact.ts`)
  - 新增 `ChatroomApiResponse`、`ChatroomApiItem` 接口
  - 新增 `ChatroomUserApiItem` 接口
  - 完善 `Chatroom` 和 `ChatroomMember` 类型定义

#### 界面增强

- **ChatHeader 组件优化**
  - 群聊会话头部显示实时成员数量（替代消息总数）
  - 成员数量通过 API 动态获取
  - 响应式监听会话变化，自动更新人数
  - 显示格式：`群聊 · XX人`

- **ContactDetail 页面增强**
  - 新增群聊详情专属区域
  - 显示群聊名称、群主、成员数量
  - 展示前 10 个群成员列表，支持查看更多
  - 群主标签特殊标识（橙色 + "群主"徽章）
  - 支持手动刷新群聊信息
  - 集成骨架屏加载动画
  - 错误状态友好提示和重试功能

- **显示名称优化**
  - 提取 `useDisplayName` composable，代码重用性提升
  - 群主和群成员使用 `useDisplayName` composable
  - 显示优先级：备注 > 昵称 > 别名 > 微信号
  - 批量加载成员显示名称，提升性能
  - 自动从联系人缓存中获取友好名称
  - 聊天组件重构，统一使用 composable 获取显示名称

#### 消息功能增强

- **智能消息加载**
  - 新增实时消息类型支持（Live Message）
  - 更智能的历史消息加载逻辑
  - 自动过滤重复消息，避免数据冗余

- **日期分隔符优化**
  - 日期分隔符显示该日消息数量
  - 格式：`YYYY年MM月DD日 (X条消息)`
  - 帮助用户快速了解消息分布

- **表情占位符改进**
  - 使用 `PictureFilled` 图标作为表情占位符
  - 视觉效果更统一、更美观

### Changed

- **数据库版本升级**
  - IndexedDB 版本从 v2 升级至 v3
  - 自动迁移旧版本数据

- **显示逻辑调整**
  - ChatHeader 副标题移除消息总数显示
  - 群聊类型会话优先显示成员数量

- **配置集中化**
  - 集中管理 debug 标志
  - 添加主题变化监听器
  - 提升配置管理的一致性

### Technical Improvements

- **多级缓存机制**
  - 实现内存 → IndexedDB → API 三级缓存策略
  - 提升数据加载速度和用户体验
  - 减少不必要的 API 请求

- **批量操作优化**
  - 使用 `Promise.all` 并行加载成员显示名称
  - 批量获取群聊详情支持
  - 提升大量数据处理性能

- **响应式设计优化**
  - SearchDialog 支持桌面端和移动端自适应
  - 移动端日期选择器优化，防止超出屏幕
  - 动态监听窗口大小变化，实时调整布局
  - 对话框宽度使用 CSS 变量控制，避免全局覆盖

- **代码重构**
  - 提取 `useDisplayName` composable，提高代码复用性
  - 聊天组件代码优化，逻辑更清晰
  - 集中管理配置和标志位

- **错误处理增强**
  - 完善的错误捕获和日志输出
  - 友好的错误提示和重试机制
  - 防御性编程，避免空值异常

- **TypeScript 类型安全**
  - 完整的类型定义和类型检查
  - 接口响应数据转换和验证
  - 减少运行时类型错误

### Fixed

- 修复群聊详情加载失败时的空状态显示
- 修复成员显示名称回退逻辑
- 修复 IndexedDB 升级时的数据清理问题
- 修复加载历史消息时的重复消息问题
- 修复移动端日期选择器超出屏幕问题
- 修复 SearchDialog 在不同设备上的显示问题

### Performance

- 使用 IndexedDB 缓存群聊数据，减少 API 调用
- 批量加载成员信息，避免单个查询
- 响应式数据更新，避免不必要的重新渲染
- 智能消息加载，避免重复数据
- 优化日期分隔符渲染逻辑
- 提取 composable 减少组件重复渲染

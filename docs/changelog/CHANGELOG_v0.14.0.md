# Changelog

## [0.14.0] - 2025-11-25

### Added

#### 聊天记录/转发消息增强

-   **新增多种消息类型支持**: 聊天记录（转发消息）对话框现在可以正确解析并展示更多类型的消息，显著提升了信息完整性。
    -   **视频消息 (`DataType: 4, 5, 43`)**:
        -   对话框内会显示视频的缩略图，并叠加播放图标，用户可点击预览。
        -   修复了 `DataType: 4` 被错误识别为语音的问题。
    -   **位置消息 (`DataType: 6, 48`)**:
        -   新增了对 `DataType: 6` 的支持。
        -   对话框内会显示位置图标、位置名称或标签。
    -   **视频链接消息 (`type: 49, subType: 4`)**:
        -   消息列表中新增了对视频链接卡片的支持。
        -   点击卡片可直接在浏览器中打开并播放视频。

#### 消息列表体验优化

-   **日期快速导航**:
    -   在消息列表的右下角新增了日期快速导航栏。
    -   用户可以点击具体日期（如 “昨”, “周三”, “11.17”）快速跳转到该日期的第一条消息，极大方便了长对话的浏览。
-   **列表底部提示**:
    -   当消息列表滚动到底部时，会显示“到了底部”的提示，为用户提供了明确的视觉反馈。

#### 历史消息加载与虚拟消息

-   **引入虚拟消息机制**: 为了更清晰地展示消息加载状态和历史空缺，引入了多种虚拟消息类型。
    -   **空档消息 (`EmptyRange`)**: 当加载历史消息时，如果某个时间段内没有聊天记录，系统会自动插入一条“空档”提示（例如：“2025-01-08 ~ 2025-01-15 没有消息”），让用户明确知道该时段的历史是完整的。
    -   **加载间隙 (`Gap`)**: 用于标记两个已加载消息段之间可能存在的未加载消息。
    -   **撤回消息 (`Revoke`)**: 撤回的消息现在会以系统提示的形式（例如：“xxx 撤回了一条消息”）在消息列表中正确渲染。

### Changed

-   **虚拟消息显示策略**: 移除了仅在 Debug 模式下显示虚拟消息的限制，现在所有用户都能看到 “空档”、“间隙” 等提示，提升了历史消息加载的透明度。
-   **时间处理工具**: 将东八区（CST）时区的时间格式化逻辑从业务组件中提取，统一整合到 `utils/timezone.ts` 中，实现了代码的复用和集中管理。
-   **消息缓存更新**: 简化并优化了 `chat.ts` 中用于更新消息缓存的逻辑，提升了数据处理效率。

### Fixed

-   **会话列表预览**: 修复了当一个会话设置了昵称（`nickName`）但其最后一条消息内容为空时，会话列表无法正确显示消息预览的问题。
-   **消息跳转功能**: 修复了 `scrollToMessage` 函数因消息 ID 类型不匹配（期望 `string` 但得到 `number`）而导致的 TypeScript 编译错误。

### Technical Details

-   **消息类型扩展**:
    -   新增了虚拟消息类型常量: `MESSAGE_TYPE.REVOKE`, `MESSAGE_TYPE.GAP`, `MESSAGE_TYPE.EMPTY_RANGE`。
    -   在 `ForwardedDialog` 中扩展了 `DataType` 的支持范围，增加了视频 (`4`) 和位置 (`6`) 类型。
    -   新增了富文本消息子类型 `RICH_MESSAGE_SUBTYPE.VIDEO_LINK` (`4`)。
-   **组件实现**:
    -   在 `MessageList.vue` 中新增了 `DateNav` 组件，用于实现日期快速跳转功能。
    -   `ForwardedDialog.vue` 组件内部逻辑更新，根据 `DataType` 渲染视频缩略图和位置信息。
-   **代码重构**:
    -   创建了 `formatCSTTime` 等函数，统一处理与时区相关的日期格式化。
    -   `chat.ts` 的 `messagesByDate` 计算属性返回的数据结构优化，解耦了原始日期和格式化日期的关系。

### User Experience

-   **导航效率**: 新增的日期导航功能使用户能够快速在冗长的聊天记录中定位信息，显著提升了浏览效率。
-   **状态透明**: 历史消息加载过程中的“空档”和“间隙”提示，让用户对消息的完整性有更清晰的认知，减少了因不确定性带来的困扰。
-   **信息保真度**: 转发消息对话框现在能更完整地还原原始聊天场景，视频和位置等信息的加入让沟通上下文更加清晰。

### Migration Guide

#### 从 v0.13.0 升级

本次更新主要集中在功能增强和内部重构，不涉及破坏性变更。用户升级后无需执行任何特殊操作。

### Testing

#### 功能测试清单

-   [ ] **转发消息**
    -   [ ] 验证包含视频（`DataType: 4`）的聊天记录能正确显示缩略图和播放按钮。
    -   [ ] 验证包含位置（`DataType: 6`）的聊天记录能正确显示位置名称。
    -   [ ] 验证视频链接消息（`subType: 4`）能以卡片形式展示并可以点击打开。
-   [ ] **消息列表**
    -   [ ] 验证日期快速导航栏在有消息时正常显示。
    -   [ ] 验证点击日期导航项能平滑滚动到对应位置。
    -   [ ] 验证滚动到列表最底部时，会出现“到了底部”的提示。
-   [ ] **历史消息**
    -   [ ] 在加载历史时，验证时间断层处会显示“空档消息”提示。
    -   [ ] 验证撤回的消息显示为“xxx 撤回了一条消息”。
-   [ ] **Bug 修复**
    -   [ ] 验证设置了昵称且最后一条消息为空的会话，预览区显示 `[非文本消息]` 而不是空白。
    -   [ ] 验证通过日期导航或点击跳转时，控制台无 TypeScript 类型错误。